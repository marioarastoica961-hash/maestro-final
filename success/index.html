<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanks — Maestro Market</title>
  <link rel="stylesheet" href="/theme.css" />
  <style>
    :root { --brand:#0b7a4b; --bg:#f8f9fa; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:var(--bg); }
    header { background: linear-gradient(180deg, #17a36b, var(--brand)); color:#fff; }
    header .wrap { max-width:980px; margin:auto; padding:14px 16px; display:flex; justify-content:space-between; align-items:center; }
    main   .wrap { max-width:980px; margin:auto; padding:24px 16px; }
    .card  { background:#fff; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:20px; }
    h1 { margin:0 0 8px; }
    .muted { color:#58606a; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 300px; }
    .btn { display:inline-flex; align-items:center; gap:10px; background:var(--brand); color:#fff; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; text-decoration:none; }
    .btn:focus { outline: 2px solid #0a5e3a; outline-offset:2px; }
    .btn.secondary { background:#1f2937; }
    .btn.copy { background:#0a6bb8; }
    code { background:#eef2f7; padding:2px 6px; border-radius:6px; }
    .ok { color:#0b7a4b; font-weight:700; }
    .warn { background:#fff7e6; border:1px solid #ffd48a; padding:12px; border-radius:12px; }
    .tips { font-size:14px; line-height:1.5; }
    .grid { display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 800px){ .grid { grid-template-columns: 1.2fr .8fr; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <strong><a href="/" style="color:#fff; text-decoration:none;">Maestro Market</a></strong>
      <nav><a href="/agents/" style="color:#fff">Agentes</a> · <a href="/account/" style="color:#fff">Mi cuenta</a></nav>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <section class="card">
          <h1>Pago procesado ✅</h1>
          <p class="muted" id="orderLine">Order: <code id="orderId">—</code></p>

          <p class="tips" id="statusTip">
            Para recibir tu agente por Telegram, usa el botón aquí abajo.
          </p>

          <div style="display:flex; gap:12px; flex-wrap:wrap; margin:16px 0;">
            <!-- Botón Telegram -->
            <a id="tgBtn" class="btn" href="#" target="_blank" rel="noopener">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M22 2L2.94 9.37c-.84.33-.83 1.54.02 1.84l4.9 1.73 2 6.32c.26.83 1.32 1.08 1.93.45l2.77-2.86 5.08 3.73c.86.63 2.08.16 2.3-.9L24 3.27C24.2 2.33 23.1 1.64 22 2zm-4.7 5.61l-8.76 7.68-.29 3.21 1.84-1.9 7.21-9z"/></svg>
              Recibir en Telegram
            </a>

            <!-- Copiar /start -->
            <button id="copyBtn" class="btn copy" type="button">
              Copiar “/start &lt;order_id&gt;”
            </button>

            <!-- Ver detalles del pedido (KV debug opcional) -->
            <a id="ordersBtn" class="btn secondary" href="https://pay.hazelsophia.tech/orders?prefix=pay:" target="_blank" rel="noopener">Ver pedidos (admin)</a>
          </div>

          <div id="warnBox" class="warn" style="display:none;">
            Si el botón de Telegram no abre el chat, búscanos manualmente en Telegram como
            <code id="botMention"></code> y envía:
            <code id="startCmd"></code>
          </div>

          <hr style="margin:20px 0; border:none; border-top:1px solid #eee" />

          <div class="tips">
            <ul>
              <li>Si cerraste Telegram Web/ móvil, puedes volver a este enlace desde tu email de confirmación.</li>
              <li>Si pagaste hace menos de 2–3 minutos, la confirmación puede tardar en llegar; te avisaremos en el bot.</li>
            </ul>
          </div>
        </section>

        <aside class="card">
          <h3>¿Qué sigue?</h3>
          <ol class="tips" style="margin-top:6px;">
            <li>Pulsa <span class="ok">“Recibir en Telegram”</span>.</li>
            <li>Se abrirá nuestro bot con <code>/start &lt;order_id&gt;</code> ya rellenado.</li>
            <li>El bot verificará tu pago y te entregará el agente.</li>
          </ol>
          <p class="muted">¿Problemas? Escríbenos con tu <em>order_id</em>.</p>
        </aside>
      </div>
    </div>
  </main>

  <script>
    // ⚙️ CONFIGURA el usuario del bot si hace falta:
    const BOT_USERNAME = 'MaestroDirectorBot'; // ← cámbialo si tu @ del bot es otro

    (function(){
      const qs = new URLSearchParams(location.search);
      const orderId = qs.get('order_id') || '';
      const botFromParam = qs.get('bot') || '';
      const botUser = (botFromParam || BOT_USERNAME).replace(/^@/, '');

      const $orderId = document.getElementById('orderId');
      const $tgBtn   = document.getElementById('tgBtn');
      const $copyBtn = document.getElementById('copyBtn');
      const $warn    = document.getElementById('warnBox');
      const $botMention = document.getElementById('botMention');
      const $startCmd   = document.getElementById('startCmd');

      if (!orderId) {
        document.getElementById('statusTip').textContent =
          'No encontramos el order_id en la URL. Revisa el correo de confirmación o vuelve al checkout.';
        $tgBtn.style.display = 'none';
        $copyBtn.style.display = 'none';
        return;
      }

      $orderId.textContent = orderId;

      // Enlace profundo a Telegram con /start <order_id>
      const deepLink = `https://t.me/${encodeURIComponent(botUser)}?start=${encodeURIComponent(orderId)}`;
      $tgBtn.href = deepLink;

      // Fallback info
      $botMention.textContent = '@' + botUser;
      $startCmd.textContent = `/start ${orderId}`;

      // Intento de “abrir app Telegram” en mobile: si no se abre, dejamos el fallback visible
      let showedWarn = false;
      const showWarnSoon = () => {
        if (showedWarn) return;
        showedWarn = true;
        $warn.style.display = 'block';
      };
      // Si el usuario vuelve, verá el aviso (por si el deep link no abrió app)
      setTimeout(showWarnSoon, 2500);

      // Copiar /start <order_id>
      $copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(`/start ${orderId}`);
          $copyBtn.textContent = '¡Copiado!';
          setTimeout(()=>($copyBtn.textContent='Copiar “/start <order_id>”'), 1600);
        } catch(e) {
          showWarnSoon();
        }
      });
    })();
  </script>
</body>
</html>
