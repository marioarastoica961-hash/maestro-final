<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout — Maestro Market (Debug)</title>
  <link rel="stylesheet" href="/theme.css" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; background:#f8f9fa; }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 20px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .price { font-size: 28px; font-weight: 700; }
    .muted { color: #666; }
    button { background:#0b7a4b; color:#fff; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    input, select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; }
    header { background: linear-gradient(180deg, #17a36b, #0b7a4b); color:#fff; padding:14px 0; }
    header .container { display:flex; align-items:center; justify-content:space-between; }
    a { color: inherit; text-decoration: none; }
    .err { background:#ffe8e8; color:#a20000; padding:10px 12px; border-radius:10px; margin-top:12px; display:none; }
    .debug { background:#f1f5f9; border:1px dashed #94a3b8; padding:12px; border-radius:12px; font-size:12px; white-space:pre-wrap; }
    .pill { display:inline-block; background:#e2f7ee; color:#065f46; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <strong><a href="/">Maestro Market</a></strong>
      <nav><a href="/agents/">Agentes IA</a> · <a href="/leads/">Leads</a> · <a href="/account/">Mi Cuenta</a></nav>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h1>Review your order <span class="pill">DEBUG</span></h1>

      <div class="row">
        <section>
          <table style="width:100%; border-collapse:separate; border-spacing:0 8px;">
            <tr><td class="muted">Agent:</td><td id="agentName" style="text-align:right;"></td></tr>
            <tr><td class="muted">Delivery:</td><td id="deliveryText" style="text-align:right;"></td></tr>
            <tr><td class="muted">Base price:</td><td id="basePrice" style="text-align:right;" class="price">$0</td></tr>
            <tr><td class="muted">Surcharge:</td><td id="surcharge" style="text-align:right;">$0</td></tr>
            <tr><td class="muted" style="font-weight:700;">Total:</td><td id="total" style="text-align:right; font-weight:800; font-size:24px;">$0</td></tr>
          </table>
        </section>

        <section>
          <label for="email">Your email</label>
          <input type="email" id="email" placeholder="tu@correo.com" required />
          <div style="height:12px;"></div>
          <button id="btnPay" disabled>Pay with crypto</button>
          <div id="err" class="err"></div>
        </section>

        <section>
          <h3 style="margin:0 0 8px;">Debug info</h3>
          <div class="debug" id="debugBox">loading…</div>
        </section>
      </div>
    </div>
  </main>

  <script>
  (async function () {
    const WORKER_BASE = 'https://pay.hazelsophia.tech';
    const qs = new URLSearchParams(location.search);
    const slug = (qs.get('slug') || '').trim();
    const delivery = (qs.get('delivery') || 'instant').toLowerCase();

    // UI refs
    const $name = document.getElementById('agentName');
    const $delivery = document.getElementById('deliveryText');
    const $base = document.getElementById('basePrice');
    const $fee = document.getElementById('surcharge');
    const $total = document.getElementById('total');
    const $email = document.getElementById('email');
    const $btnPay = document.getElementById('btnPay');
    const $err = document.getElementById('err');
    const $debug = document.getElementById('debugBox');

    const fmt = v => `$${Number(v).toFixed(2)}`;
    const surchargeOf = d => d === 'instant' ? 24 : d === '24h' ? 12 : d === '48h' ? 3 : 0;

    function setDebug(obj) {
      $debug.textContent = JSON.stringify(obj, null, 2);
    }

    try {
      if (!slug) {
        setDebug({ error: 'missing slug param' });
        return;
      }

      const url = '/assets/data/agents.json?v=' + crypto.randomUUID();
      const res = await fetch(url, { cache: 'no-store' });
      const list = await res.json();

      // encontrar agente
      let agent = null;
      if (Array.isArray(list)) {
        agent = list.find(a => (a.slug || a.id) === slug);
      } else if (list && typeof list === 'object') {
        agent = list[slug] || null;
      }

      // calcular base (incluye price_usd)
      const base = agent ? Number(
        agent.price ??
        agent.basePrice ??
        agent.cost ??
        agent.price_usd ??
        0
      ) : 0;

      const fee = surchargeOf(delivery);
      const total = base + fee;

      // pintar UI
      $name.textContent = agent ? (agent.name || agent.title || slug) : '(not found)';
      $delivery.textContent = delivery;
      $base.textContent = fmt(base);
      $fee.textContent = fmt(fee);
      $total.textContent = fmt(total);

      // debug visible
      setDebug({
        fetched_from: url,
        slug_param: slug,
        delivery_param: delivery,
        agent_found: !!agent,
        agent_keys: agent ? Object.keys(agent) : null,
        agent_sample: agent || null,
        computed: { base, fee, total }
      });

      // habilitar pay si email válido y base > 0
      function validate() {
        $btnPay.disabled = !( $email.value && $email.validity.valid && base > 0 );
      }
      $email.addEventListener('input', validate);
      validate();

      $btnPay.addEventListener('click', async () => {
        $btnPay.disabled = true;
        $err.style.display = 'none';
        try {
          if (base <= 0) throw new Error('Base price is 0 — NOWPayments no acepta 0. Revisa price_usd en catálogo.');
          const payload = {
            email: $email.value.trim(),
            slug,
            agent_name: agent.name || agent.title || slug,
            base_price: base,
            delivery,
            surcharge: fee,
          };
          const resp = await fetch(WORKER_BASE + '/create-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const txt = await resp.text();
          let data = {};
          try { data = JSON.parse(txt); } catch {}
          if (!resp.ok) throw new Error(data.error || txt || 'Error creando factura');
          if (!data.invoice_url) throw new Error('Worker no devolvió invoice_url');
          location.href = data.invoice_url;
        } catch (e) {
          $err.textContent = String(e.message || e);
          $err.style.display = 'block';
          $btnPay.disabled = false;
        }
      });
    } catch (e) {
      setDebug({ exception: String(e) });
    }
  })();
  </script>
</body>
</html>
